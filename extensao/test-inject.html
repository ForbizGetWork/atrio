<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Teste de Inje√ß√£o da Extens√£o</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        pre {
            background: #fff;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>üîç Teste de Inje√ß√£o da Extens√£o Atrio</h1>

    <div id="status"></div>

    <h2>Instru√ß√µes:</h2>
    <ol>
        <li>Abra uma aba com a Senior X e fa√ßa login</li>
        <li>Volte para esta aba</li>
        <li>Clique no bot√£o abaixo</li>
    </ol>

    <button onclick="testExtension()" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">
        üß™ Testar Extens√£o
    </button>

    <div id="results"></div>

    <script>
        // Log inicial
        console.log('üß™ P√°gina de teste carregada');
        console.log('üìç URL atual:', window.location.href);

        // Verificar se extens√£o j√° est√° presente
        window.addEventListener('DOMContentLoaded', () => {
            checkExtensionStatus();
        });

        // Escutar evento da extens√£o
        window.addEventListener('senior-context-ready', (event) => {
            console.log('‚úÖ Evento senior-context-ready recebido!', event.detail);
            checkExtensionStatus();
        });

        function checkExtensionStatus() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');

            // Verificar localStorage
            const userInfo = localStorage.getItem('SENIOR_USER_INFO');
            const token = localStorage.getItem('SENIOR_TOKEN');

            let html = '<h2>üìä Status Atual:</h2>';

            // Status da extens√£o
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                html += '<div class="status success">‚úÖ API chrome.runtime dispon√≠vel (extens√£o pode estar ativa)</div>';
            } else {
                html += '<div class="status error">‚ùå API chrome.runtime N√ÉO dispon√≠vel</div>';
            }

            // Status do SENIOR_USER_INFO
            if (userInfo) {
                try {
                    const parsed = JSON.parse(userInfo);
                    const username = parsed.data?.username || 'N/A';
                    html += `<div class="status success">‚úÖ SENIOR_USER_INFO encontrado<br>Usu√°rio: <strong>${username}</strong></div>`;
                    html += `<pre>${JSON.stringify(parsed, null, 2)}</pre>`;
                } catch (e) {
                    html += '<div class="status error">‚ùå SENIOR_USER_INFO existe mas est√° malformado</div>';
                }
            } else {
                html += '<div class="status error">‚ùå SENIOR_USER_INFO N√ÉO encontrado no localStorage</div>';
            }

            // Status do SENIOR_TOKEN
            if (token) {
                html += `<div class="status success">‚úÖ SENIOR_TOKEN encontrado<br>Token: <code>${token.substring(0, 30)}...</code></div>`;
            } else {
                html += '<div class="status error">‚ùå SENIOR_TOKEN N√ÉO encontrado no localStorage</div>';
            }

            // Instru√ß√µes
            if (!userInfo || !token) {
                html += '<div class="status info">‚ÑπÔ∏è A extens√£o pode n√£o estar injetando dados. Certifique-se de:<br>';
                html += '1. Estar acessando via GitHub Pages (https://forbizgetwork.github.io/atrio/)<br>';
                html += '2. Ter feito login na Senior X em outra aba<br>';
                html += '3. A extens√£o estar instalada e ativa</div>';
            }

            resultsDiv.innerHTML = html;
        }

        function testExtension() {
            console.log('üß™ Testando comunica√ß√£o com extens√£o...');

            if (typeof chrome === 'undefined' || !chrome.runtime) {
                alert('‚ùå chrome.runtime n√£o dispon√≠vel. A extens√£o pode n√£o estar instalada.');
                return;
            }

            try {
                chrome.runtime.sendMessage({ action: 'getSeniorContext' }, (response) => {
                    console.log('üì® Resposta da extens√£o:', response);

                    if (chrome.runtime.lastError) {
                        console.error('‚ùå Erro:', chrome.runtime.lastError);
                        alert('‚ùå Erro ao comunicar: ' + chrome.runtime.lastError.message);
                        return;
                    }

                    if (response && response.userInfo && response.token) {
                        alert('‚úÖ Resposta recebida! Verificando dados...');
                        checkExtensionStatus();
                    } else {
                        alert('‚ö†Ô∏è Extens√£o respondeu mas sem dados. Fa√ßa login na Senior X primeiro.');
                    }
                });
            } catch (e) {
                console.error('‚ùå Erro ao testar:', e);
                alert('‚ùå Erro: ' + e.message);
            }
        }

        // Auto-check a cada 2 segundos
        setInterval(checkExtensionStatus, 2000);
    </script>
</body>

</html>